import{s as j,j as s}from"./index-CQ1VtCuz.js";import{r as o}from"./vendor-Bw8Oeg0g.js";import{M as N,X as C,_ as k,a2 as E,x as P}from"./libs-CW3sJYx5.js";var z={};const R=({isOpen:d,onClose:w,currentUser:t,t:B})=>{const[c,m]=o.useState([]),[l,p]=o.useState(""),[v,f]=o.useState(!1),[x,u]=o.useState(!1),h=o.useRef(null),g=o.useRef(null),S=()=>{var e;(e=h.current)==null||e.scrollIntoView({behavior:"smooth"})};o.useEffect(()=>{var e;d&&(A(),(e=g.current)==null||e.focus(),t&&"serviceWorker"in navigator&&"PushManager"in window&&I())},[d,t]),o.useEffect(()=>{S()},[c]),o.useEffect(()=>{const e=a=>{((t==null?void 0:t.role)==="ADMIN"||a.userId===(t==null?void 0:t.id)||!t&&!a.userId)&&m(i=>i.some(n=>n.id===a.id)?i:[...i,a])};return j.on("new_support_message",e),()=>{j.off("new_support_message",e)}},[t]);const A=async()=>{if(t){f(!0);try{const a=await(await fetch("/api/support/messages",{headers:{Authorization:`Bearer ${localStorage.getItem("snapify_token")}`}})).json();m(a)}catch(e){console.error("Failed to load support messages:",e)}finally{f(!1)}}},y=async()=>{if(!(!l.trim()||x)){u(!0);try{const e=await fetch("/api/support/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${localStorage.getItem("snapify_token")}`:void 0},body:JSON.stringify({message:l.trim()})});e.ok?p(""):console.error("Failed to send message:",e.statusText)}catch(e){console.error("Failed to send message:",e)}finally{u(!1)}}},_=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),y())},I=async()=>{try{const a=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:M(z.VITE_VAPID_PUBLIC_KEY||"")});await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("snapify_token")}`},body:JSON.stringify({subscription:a})})}catch(e){console.warn("Push notification subscription failed:",e)}},M=e=>{const a="=".repeat((4-e.length%4)%4),i=(e+a).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(i),b=new Uint8Array(n.length);for(let r=0;r<n.length;++r)b[r]=n.charCodeAt(r);return b},T=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return d?s.jsx("div",{className:"fixed inset-0 z-[100] flex items-end justify-center p-4 pointer-events-none",children:s.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-2xl border border-slate-200 pointer-events-auto max-h-[80vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"bg-indigo-100 p-2 rounded-full",children:s.jsx(N,{className:"w-5 h-5 text-indigo-600"})}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-bold text-slate-900",children:"Support Chat"}),s.jsx("p",{className:"text-xs text-slate-500",children:(t==null?void 0:t.role)==="ADMIN"?"Administrator":"Get help from our team"})]})]}),s.jsx("button",{onClick:w,className:"text-slate-400 hover:text-slate-600 p-1",children:s.jsx(C,{size:20})})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0",children:[v?s.jsx("div",{className:"flex justify-center py-8",children:s.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"})}):c.length===0?s.jsxs("div",{className:"text-center py-8 text-slate-500",children:[s.jsx(N,{className:"w-12 h-12 mx-auto mb-3 text-slate-300"}),s.jsx("p",{className:"text-sm",children:"No messages yet. How can we help you?"})]}):c.map(e=>s.jsx("div",{className:`flex ${e.isFromAdmin?"justify-start":"justify-end"}`,children:s.jsxs("div",{className:`max-w-[80%] rounded-2xl px-4 py-2 ${e.isFromAdmin?"bg-slate-100 text-slate-900":"bg-indigo-600 text-white"}`,children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.isFromAdmin?s.jsx(k,{size:14,className:"text-slate-600"}):s.jsx(E,{size:14,className:"opacity-80"}),s.jsx("span",{className:"text-xs font-medium opacity-75",children:e.userName}),s.jsx("span",{className:"text-xs opacity-60",children:T(e.createdAt)})]}),s.jsx("p",{className:"text-sm leading-relaxed",children:e.message})]})},e.id)),s.jsx("div",{ref:h})]}),s.jsxs("div",{className:"p-4 border-t border-slate-200",children:[s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{ref:g,type:"text",value:l,onChange:e=>p(e.target.value),onKeyPress:_,placeholder:"Type your message...",className:"flex-1 px-4 py-2 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm",disabled:x}),s.jsx("button",{onClick:y,disabled:!l.trim()||x,className:"bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white p-2 rounded-full transition-colors disabled:cursor-not-allowed",children:s.jsx(P,{size:18})})]}),s.jsxs("p",{className:"text-xs text-slate-500 mt-2 text-center",children:[t?"":"Continue as guest â€¢ ","Messages are responded to during business hours"]})]})]})}):null};export{R as SupportChat};
