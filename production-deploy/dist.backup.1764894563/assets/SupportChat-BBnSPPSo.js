import{s as N,j as s}from"./index-CC3WzsEc.js";import{R as P,M as w,X as z,O as B,_ as D,u as E}from"./libs-CBAR_Xud.js";import"./vendor-BSeQcPOp.js";import"./auth-BXl3LOEh.js";import"./utils-D9li4S3w.js";var F={};const{useState:l,useEffect:m,useRef:v}=P,J=({isOpen:d,onClose:S,currentUser:a,t:R})=>{const[c,p]=l([]),[n,x]=l(""),[A,f]=l(!1),[u,h]=l(!1),g=v(null),y=v(null),_=()=>{g.current?.scrollIntoView({behavior:"smooth"})};m(()=>{d&&(I(),y.current?.focus(),a&&"serviceWorker"in navigator&&"PushManager"in window&&T())},[d,a]),m(()=>{_()},[c]),m(()=>{const e=t=>{(a?.role==="ADMIN"||t.userId===a?.id||!a&&!t.userId)&&p(i=>i.some(o=>o.id===t.id)?i:[...i,t])};return N.on("new_support_message",e),()=>{N.off("new_support_message",e)}},[a]);const I=async()=>{if(a){f(!0);try{const t=await(await fetch("/api/support/messages",{headers:{Authorization:`Bearer ${localStorage.getItem("snapify_token")}`}})).json();p(t)}catch(e){console.error("Failed to load support messages:",e)}finally{f(!1)}}},b=async()=>{if(!(!n.trim()||u)){h(!0);try{const e=await fetch("/api/support/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:a?`Bearer ${localStorage.getItem("snapify_token")}`:void 0},body:JSON.stringify({message:n.trim()})});e.ok?x(""):console.error("Failed to send message:",e.statusText)}catch(e){console.error("Failed to send message:",e)}finally{h(!1)}}},M=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),b())},T=async()=>{try{const t=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:C(F.VITE_VAPID_PUBLIC_KEY||"")});await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("snapify_token")}`},body:JSON.stringify({subscription:t})})}catch(e){console.warn("Push notification subscription failed:",e)}},C=e=>{const t="=".repeat((4-e.length%4)%4),i=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(i),j=new Uint8Array(o.length);for(let r=0;r<o.length;++r)j[r]=o.charCodeAt(r);return j},k=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return d?s.jsx("div",{className:"fixed inset-0 z-[100] flex items-end justify-center p-4 pointer-events-none",children:s.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-2xl border border-slate-200 pointer-events-auto max-h-[80vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"bg-indigo-100 p-2 rounded-full",children:s.jsx(w,{className:"w-5 h-5 text-indigo-600"})}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-bold text-slate-900",children:"Support Chat"}),s.jsx("p",{className:"text-xs text-slate-500",children:a?.role==="ADMIN"?"Administrator":"Get help from our team"})]})]}),s.jsx("button",{onClick:S,className:"text-slate-400 hover:text-slate-600 p-1",children:s.jsx(z,{size:20})})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0",children:[A?s.jsx("div",{className:"flex justify-center py-8",children:s.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"})}):c.length===0?s.jsxs("div",{className:"text-center py-8 text-slate-500",children:[s.jsx(w,{className:"w-12 h-12 mx-auto mb-3 text-slate-300"}),s.jsx("p",{className:"text-sm",children:"No messages yet. How can we help you?"})]}):c.map(e=>s.jsx("div",{className:`flex ${e.isFromAdmin?"justify-start":"justify-end"}`,children:s.jsxs("div",{className:`max-w-[80%] rounded-2xl px-4 py-2 ${e.isFromAdmin?"bg-slate-100 text-slate-900":"bg-indigo-600 text-white"}`,children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.isFromAdmin?s.jsx(B,{size:14,className:"text-slate-600"}):s.jsx(D,{size:14,className:"opacity-80"}),s.jsx("span",{className:"text-xs font-medium opacity-75",children:e.userName}),s.jsx("span",{className:"text-xs opacity-60",children:k(e.createdAt)})]}),s.jsx("p",{className:"text-sm leading-relaxed",children:e.message})]})},e.id)),s.jsx("div",{ref:g})]}),s.jsxs("div",{className:"p-4 border-t border-slate-200",children:[s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{ref:y,type:"text",value:n,onChange:e=>x(e.target.value),onKeyPress:M,placeholder:"Type your message...",className:"flex-1 px-4 py-2 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm",disabled:u}),s.jsx("button",{onClick:b,disabled:!n.trim()||u,className:"bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white p-2 rounded-full transition-colors disabled:cursor-not-allowed",children:s.jsx(E,{size:18})})]}),s.jsxs("p",{className:"text-xs text-slate-500 mt-2 text-center",children:[a?"":"Continue as guest â€¢ ","Messages are responded to during business hours"]})]})]})}):null};export{J as SupportChat};
